<!doctype html>
<html lang="en" class="no-js">
  <head>
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta charset="utf-8">
    <meta content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" name="viewport">
      <meta name="robots" content="noindex">

    <title>Concepts | Cloud Platform User Guide</title>

    <!--[if gt IE 8]><!--><link href="/stylesheets/screen.css" rel="stylesheet" media="screen" /><!--<![endif]-->
    <!--[if lte IE 8]><link href="/stylesheets/screen-old-ie.css" rel="stylesheet" media="screen" /><![endif]-->

    <link rel="canonical" href="https://user-guide.cloud-platform.service.justice.gov.uk/concepts.html">


    <link href="/stylesheets/print.css" rel="stylesheet" media="print" />
    <script src="/javascripts/application.js"></script>

      <meta property="og:image" content="https://user-guide.cloud-platform.service.justice.gov.uk/images/govuk-large.png" />
      <meta property="og:site_name" content="Cloud Platform User Guide" />
      <meta property="og:title" content="Concepts" />
      <meta property="og:type" content="object" />
      <meta property="og:url" content="https://user-guide.cloud-platform.service.justice.gov.uk/concepts.html" />
      <meta property="twitter:card" content="summary" />
      <meta property="twitter:domain" content="user-guide.cloud-platform.service.justice.gov.uk" />
      <meta property="twitter:image" content="https://user-guide.cloud-platform.service.justice.gov.uk/images/govuk-large.png" />
      <meta property="twitter:title" content="Concepts | Cloud Platform User Guide" />
      <meta property="twitter:url" content="https://user-guide.cloud-platform.service.justice.gov.uk/concepts.html" />

    
  </head>

  <body>
    <div class="app-pane">
      <div class="app-pane__header toc-open-disabled">
        <a href="#content" class="skip-link">Skip to main content</a>

        <header class="header header--full-width">
  <div class="header__container">
    <div class="header__brand">
        <a href="/">
        <span class="header__title">
          Cloud Platform User Guide
            <span class="phase-banner">INTERNAL</span>
        </span>
        </a>
    </div>

      <div data-module="navigation">
        <button type="button" class="header__navigation-toggle js-nav-toggle" aria-controls="navigation" aria-label="Show or hide top level navigation">Menu</button>

        <nav id="navigation" class="header__navigation js-nav" aria-label="Top Level Navigation" aria-hidden="true">
          <ul>
              <li>
                <a href="mailto:platforms+user-guide@digital.justice.gov.uk?subject=User+guide+feedback">Feedback / Report a problem</a>
              </li>
              <li>
                <a href="/">Documentation</a>
              </li>
              <li>
                <a href="https://github.com/ministryofjustice/cloud-platform-user-guide">GitHub</a>
              </li>
          </ul>
        </nav>
      </div>
  </div>
</header>

      </div>

        <div id="toc-heading" class="toc-show fixedsticky">
          <a href="#toc" class="toc-show__label js-toc-show" aria-controls="toc">
            Table of contents <span class="toc-show__icon"></span>
          </a>
        </div>

      <div class="app-pane__body" data-module="in-page-navigation">
          <div class="app-pane__toc">
            <div class="toc" data-module="table-of-contents">
              <div class="search" data-module="search">
  <form action="https://www.google.co.uk/search" method="get" role="search">
    <input type="hidden" name="as_sitesearch" value="https://user-guide.cloud-platform.service.justice.gov.uk"/>
    <label for="search"  class="search__label">Search (via Google)</label>
    <input type="text" id="search" name="q" placeholder="Search" aria-controls="search-results" class="form-control" />
  </form>
  <div id="search-results" class="search-results" aria-hidden="true" role="dialog" aria-labelledby="search-results-title">
    <div class="search-results__inner">
      <button class="search-results__close">Close<span class="search-results__close-label"> search results</span></button>
      <h2 id="search-results-title" class="search-results__title" aria-live="polite">Results</h2>
      <div class="search-results__content"></div>
    </div>
  </div>
</div>

              <a href="#" class="toc__close js-toc-close" aria-controls="toc" aria-label="Hide table of contents"></a>
              <nav id="toc" class="js-toc-list toc__list" aria-labelledby="toc-heading" data-module="collapsible-navigation">
                      <ul>
  <li>
    <a href="/#cloud-platform-user-guide">Cloud platform user guide</a>
    <ul>
      <li>
        <ul>
          <li>
          </li>
          <li>
            <a href="/#who-is-the-platform-for">Who is the platform for</a>
          </li>
          <li>
            <a href="/#what-do-we-currently-support">What do we currently support</a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/concepts.html#concepts">Concepts</a>
    <ul>
      <li>
        <a href="/concepts.html#kubernetes">Kubernetes</a>
        <ul>
          <li>
            <a href="/concepts.html#resources">Resources</a>
          </li>
        </ul>
      </li>
      <li>
        <a href="/concepts.html#namespace-container-resource-limits">Namespace/Container Resource Limits</a>
        <ul>
          <li>
            <a href="/concepts.html#memory-versus-cpu">Memory versus CPU</a>
          </li>
          <li>
            <a href="/concepts.html#namespace-request-limits">Namespace request limits</a>
          </li>
          <li>
            <a href="/concepts.html#container-request-limits">Container request limits</a>
          </li>
          <li>
            <a href="/concepts.html#resources-requested-versus-resources-used">Resources Requested versus Resources Used</a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/tasks.html#tasks">Tasks</a>
    <ul>
      <li>
        <a href="/tasks.html#how-to-use-kubectl-to-connect-to-the-cluster">How to use kubectl to connect to the cluster</a>
        <ul>
          <li>
            <a href="/tasks.html#installation">Installation</a>
          </li>
          <li>
            <a href="/tasks.html#authentication">Authentication</a>
          </li>
          <li>
            <a href="/tasks.html#where-to-go-from-here">Where to go from here?</a>
          </li>
        </ul>
      </li>
      <li>
        <a href="/tasks.html#creating-a-cloud-platform-environment">Creating a Cloud Platform Environment</a>
        <ul>
          <li>
            <a href="/tasks.html#introduction">Introduction</a>
          </li>
          <li>
            <a href="/tasks.html#objective">Objective</a>
          </li>
          <li>
            <a href="/tasks.html#create-an-environment">Create an environment</a>
          </li>
          <li>
            <a href="/tasks.html#accessing-your-environments">Accessing your environments</a>
          </li>
          <li>
            <a href="/tasks.html#next-steps">Next steps</a>
          </li>
          <li>
            <a href="/tasks.html#environment-definition-files">Environment definition files</a>
          </li>
          <li>
            <a href="/tasks.html#namespace-resource-limits">Namespace resource limits</a>
          </li>
          <li>
            <a href="/tasks.html#namespace-yaml-files">Namespace YAML files</a>
          </li>
        </ul>
      </li>
      <li>
        <a href="/tasks.html#creating-an-ecr-repository">Creating an ECR repository</a>
        <ul>
          <li>
            <a href="/tasks.html#creating-an-ecr-repository-introduction">Introduction</a>
          </li>
          <li>
            <a href="/tasks.html#accessing-the-credentials">Accessing the credentials</a>
          </li>
          <li>
            <a href="/tasks.html#managing-ecr-repository">Managing ECR Repository</a>
          </li>
          <li>
            <a href="/tasks.html#creating-an-ecr-repository-next-steps">Next steps</a>
          </li>
        </ul>
      </li>
      <li>
        <a href="/tasks.html#creating-a-route-53-hosted-zone">Creating a Route 53 Hosted Zone</a>
        <ul>
          <li>
            <a href="/tasks.html#overview">Overview</a>
          </li>
          <li>
            <a href="/tasks.html#creating-a-route-53-hosted-zone-pre-requisites">Pre-Requisites</a>
          </li>
          <li>
            <a href="/tasks.html#terraform-files">Terraform files</a>
          </li>
          <li>
            <a href="/tasks.html#creating-the-resource">Creating the resource</a>
          </li>
        </ul>
      </li>
      <li>
        <a href="/tasks.html#adding-aws-resources-to-your-environment">Adding AWS resources to your environment</a>
        <ul>
          <li>
            <a href="/tasks.html#available-modules">Available modules</a>
          </li>
          <li>
            <a href="/tasks.html#usage">Usage</a>
          </li>
        </ul>
      </li>
      <li>
        <a href="/tasks.html#deploying-a-39-hello-world-39-application-to-the-cloud-platform">Deploying a ‘Hello World’ application to the Cloud Platform</a>
        <ul>
          <li>
            <a href="/tasks.html#deploying-a-39-hello-world-39-application-to-the-cloud-platform-overview">Overview</a>
          </li>
          <li>
            <a href="/tasks.html#prerequisites">Prerequisites</a>
          </li>
          <li>
            <a href="/tasks.html#step-1-build-your-docker-image">Step 1 - Build your docker image</a>
          </li>
          <li>
            <a href="/tasks.html#step-2-push-the-image-to-your-ecr">Step 2 - Push the image to your ECR</a>
          </li>
          <li>
            <a href="/tasks.html#step-3-configure-your-namespace-in-the-kubernetes-cluster">Step 3 - Configure your namespace in the Kubernetes Cluster</a>
          </li>
          <li>
            <a href="/tasks.html#step-4-deploy-the-application">Step 4 - Deploy the application</a>
          </li>
          <li>
            <a href="/tasks.html#interacting-with-the-application">Interacting with the application</a>
          </li>
          <li>
            <a href="/tasks.html#add-http-basic-authentication">Add HTTP Basic Authentication</a>
          </li>
        </ul>
      </li>
      <li>
        <a href="/tasks.html#deploying-a-multi-container-application-to-the-cloud-platform">Deploying a multi-container application to the Cloud Platform</a>
        <ul>
          <li>
            <a href="/tasks.html#deploying-a-multi-container-application-to-the-cloud-platform-overview">Overview</a>
          </li>
          <li>
            <a href="/tasks.html#running-in-the-kubernetes-cluster">Running in the Kubernetes Cluster</a>
          </li>
          <li>
            <a href="/tasks.html#create-an-rds-instance">Create an RDS instance</a>
          </li>
          <li>
            <a href="/tasks.html#build-docker-images-and-pushing-to-ecr">Build docker images and pushing to ECR</a>
          </li>
          <li>
            <a href="/tasks.html#kubernetes-configuration">Kubernetes configuration</a>
          </li>
          <li>
            <a href="/tasks.html#deploying-to-the-cluster">Deploying to the cluster</a>
          </li>
          <li>
            <a href="/tasks.html#deploying-a-multi-container-application-to-the-cloud-platform-interacting-with-the-application">Interacting with the application</a>
          </li>
          <li>
            <a href="/tasks.html#further-development">Further Development</a>
          </li>
        </ul>
      </li>
      <li>
        <a href="/tasks.html#deploying-with-helm-and-circleci">Deploying with Helm and CircleCI</a>
        <ul>
          <li>
            <a href="/tasks.html#prerequisite-for-live-1-deployment">Prerequisite for Live-1 deployment</a>
          </li>
          <li>
            <a href="/tasks.html#deploying-an-application-to-the-cloud-platform-with-helm">Deploying an application to the Cloud Platform with Helm</a>
          </li>
          <li>
            <a href="/tasks.html#continuous-deployment-of-an-application-using-circleci-and-helm">Continuous Deployment of an application using CircleCI and Helm</a>
          </li>
        </ul>
      </li>
      <li>
        <a href="/tasks.html#how-do-i-run-rails-database-migrations">How do I run Rails database migrations?</a>
        <ul>
          <li>
            <a href="/tasks.html#do-not-run-migrations-on-container-startup">Do not run migrations on container startup</a>
          </li>
          <li>
            <a href="/tasks.html#further-reading">Further reading</a>
          </li>
        </ul>
      </li>
      <li>
        <a href="/tasks.html#adding-a-secret-to-an-application">Adding a secret to an application</a>
        <ul>
          <li>
            <a href="/tasks.html#adding-a-secret-to-an-application-overview">Overview</a>
          </li>
          <li>
            <a href="/tasks.html#adding-a-secret-to-an-application-prerequisites">Prerequisites</a>
          </li>
          <li>
            <a href="/tasks.html#configuring-secrets">Configuring secrets</a>
          </li>
          <li>
            <a href="/tasks.html#creating-the-secret">Creating the secret</a>
          </li>
        </ul>
      </li>
      <li>
        <a href="/tasks.html#creating-pingdom-checks">Creating Pingdom checks</a>
        <ul>
          <li>
            <a href="/tasks.html#creating-pingdom-checks-overview">Overview</a>
          </li>
          <li>
            <a href="/tasks.html#creating-pingdom-checks-prerequisites">Prerequisites</a>
          </li>
          <li>
            <a href="/tasks.html#create-a-pingdom-check">Create a Pingdom check</a>
          </li>
        </ul>
      </li>
      <li>
        <a href="/tasks.html#cleaning-up">Cleaning up</a>
        <ul>
          <li>
            <a href="/tasks.html#2-tell-terraform-to-delete-your-aws-resources">2. Tell terraform to delete your AWS resources</a>
          </li>
          <li>
            <a href="/tasks.html#3-remove-your-namespace-code-from-the-cloud-platform-environments-repository">3. Remove your namespace code from the cloud-platform-environments repository</a>
          </li>
          <li>
            <a href="/tasks.html#4-delete-all-of-the-kubernetes-resources-inside-your-namespace">4. Delete all of the kubernetes resources inside your namespace.</a>
          </li>
          <li>
            <a href="/tasks.html#5-delete-your-namespace-from-the-cluster">5. Delete your namespace from the cluster.</a>
          </li>
          <li>
            <a href="/tasks.html#summary">Summary</a>
          </li>
        </ul>
      </li>
      <li>
        <a href="/tasks.html#monitoring-applications">Monitoring Applications</a>
        <ul>
          <li>
            <a href="/tasks.html#using-the-cloud-platform-prometheus-alertmanager-and-grafana">Using the Cloud Platform Prometheus, AlertManager and Grafana</a>
          </li>
          <li>
            <a href="/tasks.html#creating-your-own-custom-alerts">Creating your own custom alerts</a>
          </li>
          <li>
            <a href="/tasks.html#getting-application-metrics-into-prometheus">Getting application metrics into Prometheus</a>
          </li>
        </ul>
      </li>
      <li>
        <a href="/tasks.html#application-logging">Application Logging</a>
        <ul>
          <li>
            <a href="/tasks.html#application-log-collection-and-storage">Application Log Collection and Storage</a>
          </li>
          <li>
            <a href="/tasks.html#accessing-application-log-data">Accessing Application Log Data</a>
          </li>
        </ul>
      </li>
      <li>
        <a href="/tasks.html#migrating-from-live-0-to-live-1">Migrating from Live-0 to Live-1</a>
        <ul>
          <li>
            <a href="/tasks.html#migrating-from-live-0-to-live-1-overview">Overview</a>
          </li>
          <li>
            <a href="/tasks.html#accessing-the-live-1-cluster">Accessing the Live-1 cluster</a>
          </li>
          <li>
            <a href="/tasks.html#generating-a-new-environment">Generating a new environment</a>
          </li>
          <li>
            <a href="/tasks.html#generating-a-new-ecr-repository">Generating a new ECR repository</a>
          </li>
          <li>
            <a href="/tasks.html#changing-the-circleci-environment-variables">Changing the CircleCI environment variables</a>
          </li>
          <li>
            <a href="/tasks.html#deleting-your-live-0-deployment">Deleting your Live-0 deployment</a>
          </li>
          <li>
            <a href="/tasks.html#other-considerations">Other considerations</a>
          </li>
        </ul>
      </li>
      <li>
        <a href="/tasks.html#other-topics">Other Topics</a>
        <ul>
          <li>
            <a href="/tasks.html#git-crypt">Git-Crypt</a>
          </li>
          <li>
            <a href="/tasks.html#secrets-overview">Secrets overview</a>
          </li>
          <li>
            <a href="/tasks.html#migrating-an-rds-instance">Migrating an RDS instance</a>
          </li>
          <li>
            <a href="/tasks.html#kubectl-quick-reference">Kubectl quick reference</a>
          </li>
          <li>
            <a href="/tasks.html#cloud-platform-support">Cloud Platform Support</a>
          </li>
          <li>
            <a href="/tasks.html#zero-downtime-deployments">Zero Downtime Deployments</a>
          </li>
          <li>
            <a href="/tasks.html#using-a-custom-domain">Using a custom domain</a>
          </li>
          <li>
            <a href="/tasks.html#ip-whitelisting">IP Whitelisting</a>
          </li>
          <li>
            <a href="/tasks.html#setup-postgres-container">Setup Postgres container</a>
          </li>
          <li>
            <a href="/tasks.html#applying-a-maintenance-page">Applying a Maintenance Page</a>
          </li>
          <li>
            <a href="/tasks.html#statefulsets-pods-with-persistent-volumes">StatefulSets (Pods with Persistent Volumes)</a>
          </li>
          <li>
            <a href="/tasks.html#how-to-decommission-unused-template-deploy-services">How to decommission unused template deploy services</a>
          </li>
          <li>
            <a href="/tasks.html#troubleshooting-guide">Troubleshooting guide</a>
          </li>
          <li>
            <a href="/tasks.html#ssl-connections-with-rds">SSL connections with RDS</a>
          </li>
          <li>
            <a href="/tasks.html#kubernetes-cronjobs">Kubernetes Cronjobs</a>
          </li>
          <li>
            <a href="/tasks.html#time-zone-cronjobs">Time Zone Cronjobs</a>
          </li>
          <li>
            <a href="/tasks.html#modsecurity-web-application-firewall">ModSecurity - Web Application Firewall</a>
          </li>
          <li>
            <a href="/tasks.html#custom-default-backend">Custom default-backend</a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/reference.html#reference">Reference</a>
    <ul>
      <li>
        <a href="/reference.html#cloud-platform-operational-processes">Cloud Platform Operational Processes</a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
      <li>
        <a href="/reference.html#tasks-cloud-platform-support">Cloud Platform Support</a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
      <li>
        <a href="/reference.html#kubernetes-resources">Kubernetes resources</a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>
<ul>
  <li>
    <a href="/getting-help.html#getting-help">Getting Help</a>
    <ul>
      <li>
        <a href="/getting-help.html#slack-channel">Slack Channel</a>
      </li>
      <li>
        <a href="/getting-help.html#raise-a-support-ticket">Raise a support ticket</a>
      </li>
    </ul>
  </li>
</ul>


              </nav>
            </div>
          </div>

        <div class="app-pane__content toc-open-disabled">
          <main id="content" class="technical-documentation" data-module="anchored-headings">
              <h1 id="concepts">Concepts</h1><p><h2 id="kubernetes">Kubernetes</h2><p>The MoJ Digital Cloud Platform is based on <a href="https://kubernetes.io">Kubernetes</a> (aka <strong>&ldquo;k8s&rdquo;</strong>, because it&rsquo;s much shorter).</p>
<h3 id="resources">Resources</h3><p>Here are some links to introductory Kubernetes resources:</p></p>

<ul>
<li>For a brief and light-hearted introduction to what Kubernetes is all about, try this <a href="https://cloud.google.com/kubernetes-engine/kubernetes-comic/">comic</a> from Google.</li>
<li><a href="https://www.youtube.com/watch?v=IMOZCDhH7do">Concept video</a></li>
<li><a href="https://kubernetes.io/docs/concepts/services-networking/ingress">Ingress</a>. This is an important concept which is not covered in the official introduction document.</li>
<li><a href="https://www.katacoda.com/courses/kubernetes">Katacoda kubernetes course</a>. In-browser, free (registration required), bite-sized kubernetes lessons.</li>
<li><a href="https://www.pluralsight.com/courses/getting-started-kubernetes">Pluralsight k8s course</a></li>
<li><a href="https://eu.udacity.com/course/scalable-microservices-with-kubernetes--ud615">Udacity k8s course</a></li>
</ul>
<p><h2 id="namespace-container-resource-limits">Namespace/Container Resource Limits</h2><p>The cloud platform is a single kubernetes cluster, hosting multiple different MoJ services. So, the cluster capacity (in terms of memory and CPU) needs to be <a href="https://kubernetes.io/docs/concepts/scheduling/kube-scheduler/">shared efficiently</a> between the different services.</p>
<p>The smallest unit of work we ask the cluster to manage is a container, and in our case, the largest unit is a <a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/namespaces/">namespace</a>. The cluster has several <a href="https://kubernetes.io/docs/concepts/architecture/nodes/">worker nodes</a>, which supply the memory and CPU capacity on which workloads can run. So, kubernetes has to solve a classic <a href="https://en.wikipedia.org/wiki/Packing_problems">packing problem</a> - run a bunch of different workloads on the cluster, putting them on different worker nodes in the most efficient way possible. But, the cluster can&rsquo;t be sure in advance how much resource (memory and CPU) any given container is going to need.</p>
<p>To help with this, we specify <strong>request limits</strong>. This article will use &ldquo;request&rdquo; because that&rsquo;s the official kubernetes term, but request is a slightly awkward term here. It might be better to think of &ldquo;reserving&rdquo; rather than requesting resources.</p>
<p>Essentially, a request limit says to kubernetes, &ldquo;this thing is going to need this much memory and this much CPU in order to do its job.&rdquo; So, whenever it encounters a request limit, the <a href="https://kubernetes.io/docs/concepts/scheduling/kube-scheduler/">kube-scheduler</a> sets aside that amount of memory and CPU, and ring-fences it so that it&rsquo;s guaranteed to be available.</p>
<p>The other kind of limit in kubernetes are known as <strong>hard limits</strong>. These are important at runtime, as opposed to request limits, which are important for the scheduling decisions the cluster makes before your workloads start to run. From the name, it sounds as if these are limits that kubernetes will enforce, so that the workload will be terminated if it exceeds them. The reality is a little more nuanced. If the cluster has capacity available on the node where the workload is running, it will allow it to consume more resources than the hard limit specifies. But, it will flag the workload such that, if the node runs out of resources and kubernetes needs to evict pods, the pods from the offending workload will be first in line to be evicted.</p>
<p>For simplicity&rsquo;s sake, you can just think of a hard limit as meaning what it sounds like - the maximum amount your workload will be allowed to consume before bad things start to happen.</p>
<p>For the remainder of this article, we&rsquo;re only going to talk about request limits, since those are what is relevant for scheduling workloads onto the cluster.</p>
<h3 id="memory-versus-cpu">Memory versus CPU</h3><p>Memory and CPU are the two types of resources we need to consider, and we&rsquo;re going to pretend, for the rest of this article, that they&rsquo;re handled in the same way. The truth is that they&rsquo;re not. If a workload tries to consume more memory than is available, it may be terminated by the cluster (&lsquo;out of memory killed&rsquo;, aka OOM-killed).</p>
<p>If a workload tries to consume more CPU than is available, it will simply not receive as much CPU time as it wants, and will be throttled.</p>
<p>This distinction doesn&rsquo;t really matter, for the purposes of this article, so we&rsquo;re going to pretend we can treat memory and CPU exactly the same.</p>
<h3 id="namespace-request-limits">Namespace request limits</h3><p>A namespace is the largest &ldquo;unit of work&rdquo; that the cluster needs to worry about.</p>
<p>When you create a namespace the <a href="https://kubernetes.io/docs/concepts/policy/resource-quotas/">ResourceQuota</a> specifies limits on the amount of resources that it will allow the namespace to request. This <a href="https://github.com/ministryofjustice/cloud-platform-environments/blob/master/namespace-resources/03-resourcequota.yaml">file</a> defines the defaults we assign to new namespaces. The <code>requests.cpu</code> specifies the CPU resources, usually in <a href="https://kubernetes.io/docs/concepts/configuration/manage-compute-resources-container/#meaning-of-cpu">millicores</a> aka millicpus. <code>requests.memory</code> specifies the required memory, usually in <a href="https://en.wikipedia.org/wiki/Mebibyte">mebibytes</a>.</p>
<p>These values represent the amount of CPU and memory that the cluster will <strong>set aside as soon as this namespace is created</strong>, regardless of whether or not those resources are being used to do any useful work.</p>
<p>This means it is possible to run out of cluster resources before any work is actually performed, just by requesting (i.e. reserving) capacity.</p>
<p><a href="../images/cluster-namespace-packing.png" target="_blank" rel="noopener noreferrer"><img src="/images/cluster-namespace-packing.png" alt="Cluster namespace packing" /></a></p>
<p>For this reason, we need to be conservative when assigning request limits to namespaces. This won&rsquo;t prevent your namespace from accessing resources that it needs, but a lower request limit will help us to use the capacity of the cluster more efficiently, to run everyone&rsquo;s workloads.</p>
<h3 id="container-request-limits">Container request limits</h3><p>The smallest unit of work the cluster cares about is a container.</p>
<p>Kubernetes workloads are generally defined in terms of <a href="https://kubernetes.io/docs/concepts/workloads/pods/pod-overview/">pods</a>, where each pod defines a number of containers. Containers also have request limits and hard limits on the resources that will be set aside for them, or which they shouldn&rsquo;t exceed.</p>
<p><a href="https://raw.githubusercontent.com/ministryofjustice/fb-av/6cdba5db4e2feb440c7b6a303f241728b9cee5f8/deploy/fb-av-chart/templates/deployment.yaml">Here</a> is an example of a deployment file which specifies limits for the container it launches.</p>
<p>Whenever the scheduler tries to schedule a pod, it reserves whatever request limits are specified for each container. If the deployment doesn&rsquo;t specify request limits for a given container, the default for the namespace will be used. This default comes from the namespace&rsquo;s <a href="https://kubernetes.io/docs/concepts/policy/limit-range/">LimitRange</a>. In our case, the default we apply for new namespaces is specified <a href="https://github.com/ministryofjustice/cloud-platform-environments/blob/master/namespace-resources/02-limitrange.yaml">here</a>.</p>
<p><a href="../images/deployment-one-replica.png" target="_blank" rel="noopener noreferrer"><img src="/images/deployment-one-replica.png" alt="Deployment one replica" /></a></p>
<p>The diagram above shows a namespace with a deployment consisting of four containers. If the service team wanted to run multiple replicas of this deployment, the scheduler would not allow it, because the namespace capacity limit (the pink square) is not enough to set aside the amount of resources that each of the containers say they want (the green square; i.e. you couldn&rsquo;t fit another green square of that size inside the pink square).</p>
<h3 id="resources-requested-versus-resources-used">Resources Requested versus Resources Used</h3><p>So far, we&rsquo;ve only been talking about what resources we are <strong>requesting</strong>, and it&rsquo;s clear that we can quickly run out of capacity in the cluster if we request too many resources. But, how closely does what we request match what we use?</p>
<p>We have created <a href="https://github.com/ministryofjustice/cloud-platform-environments/blob/master/bin/namespace-reporter.rb">this script</a> that you can run to see how your namespace is doing.</p>
<p>Here is the current result (25/07/19) from running the script against the <code>monitoring</code> namespace (where things like <a href="https://prometheus.io/">prometheus</a> and <a href="https://prometheus.io/docs/alerting/alertmanager/">alert-manager</a> run)</p>
<div class="highlight"><pre class="highlight plaintext"><code>$ ./bin/namespace-reporter.rb monitoring</p>
<p>Namespace: monitoring</p>
<p>Request limit:        CPU: 10000,     Memory: 24000
Requested:            CPU: 2215,      Memory: 13115</p>
<p>Num. containers:      58
Req. per-container:   CPU: 125,       Memory: 250</p>
<p>Resources in-use:     CPU: 363,       Memory: 6795</p>
<p>CPU values are in millicores (m). Memory values are in mebibytes (Mi).
</code></pre></div><p>As you can see, we&rsquo;re doing quite badly in terms of efficient usage of cluster resources. Inside the namespace, we&rsquo;re requesting 2215 millicores of CPU, but only using 363, and we&rsquo;re requesting 13115Mi of memory, but only using 6795Mi.</p>
<p><a href="../images/requested-versus-used.png" target="_blank" rel="noopener noreferrer"><img src="/images/requested-versus-used.png" alt="Requested versus used" /></a></p>
<p>Worse still, we have a request limit of 10000m CPU and 24000Mi of memory (i.e. 10 CPU cores, and 25G of memory). Those resources have been set aside for the monitoring namespace, and are not available to run any other workloads.</p>
<p>This pattern is repeated across all the namespaces in the cluster, and it&rsquo;s a problem. We can make the cluster bigger to get more capacity, and we have done so several times, but there are knock-on effects. The more cluster nodes we have, the harder the cluster control software has to work, and some functions get slower, or even stop working altogether, so more work has to be done to scale <em>those</em> up, and so on.</p>
<p>For this reason, we&rsquo;re going to do ongoing work to <strong>right-size</strong> both new and existing namespaces and their limit ranges, so that everyone benefits by having the cluster run their workloads efficiently.</p></p>


            
          </main>

            <ul class="contribution-banner">
              <li><a href="https://github.com/ministryofjustice/cloud-platform-user-guide/blob/master/source/concepts.html.md.erb">View source</a></li>
              <li><a href="https://github.com/ministryofjustice/cloud-platform-user-guide/issues/new?labels=bug&amp;title=Re:%20'Concepts'&amp;body=Problem%20with%20'Concepts'%20(https://user-guide.cloud-platform.service.justice.gov.uk/concepts.html)">Report problem</a></li>
              <li><a href="https://github.com/ministryofjustice/cloud-platform-user-guide">GitHub Repo</a></li>
            </ul>

          <footer class="footer">
  <div class="footer__licence">
    <a class="footer__licence-logo" href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/" rel="license">Open Government Licence</a>
    <p class="footer__licence-description">All content is available under the <a href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/" rel="license">Open Government Licence v3.0</a>, except where otherwise stated</p>
  </div>

  <div class="footer__copyright">
    <a class="footer__copyright-logo" href="http://www.nationalarchives.gov.uk/information-management/re-using-public-sector-information/copyright-and-re-use/crown-copyright/">© Crown copyright</a>
  </div>
</footer>

        </div>
      </div>
    </div>

    
  </body>
</html>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-138188246-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-138188246-1');
</script>

<script>
  // Add the current window.location to the body of the
  // feedback email message.
  function sendFeedback(mailto, event) {
    event.preventDefault();

    var body = "Feedback/Problem on page: " + window.location + "\n";
    var href = mailto + '&body=' + encodeURIComponent(body);

    window.location = href;
  }

  $(document).ready(function() {
    var feedbackLink = $('a[href^="mailto:"]:contains("Feedback")')[0];
    var mailto = feedbackLink.href;
    $(feedbackLink).on('click', function(event) { sendFeedback(mailto, event); });
  });
</script>
