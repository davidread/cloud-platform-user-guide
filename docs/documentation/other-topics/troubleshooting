<h3 id="troubleshooting-guide">Troubleshooting guide</h3><p>When things are not working correctly, there are several techniques to help you figure out what&rsquo;s going wrong.</p>

<blockquote>
<p>You might find this <a href="https://learnk8s.io/troubleshooting-deployments">visual guide</a> to troubleshooting kubernetes deployments useful.</p>
</blockquote>
<h4 id="pods-events">Pods / Events</h4><p>Generally, the first step will be:</p>
<p><code>kubectl -n [your namespace] get pods</code></p>

<blockquote>
<p>We&rsquo;ve used the namespace <code>dstest</code> as an example, in this guide. Wherever that appears in a command, please use the name of your namespace instead.</p>
</blockquote>
<div class="highlight"><pre class="highlight plaintext"><code>$ kubectl -n dstest get pods
NAME                                 READY   STATUS                       RESTARTS   AGE
helloworld-rubyapp-8795b9c56-58fbc   1/2     CreateContainerConfigError   0          13s
helloworld-rubyapp-d58bdf7c4-2xqw7   1/1     Running                      0          21d
helloworld-rubyapp-d58bdf7c4-x8ln7   1/1     Running                      0          21d
</code></pre></div><p>Here, the <code>STATUS</code> value shows that there&rsquo;s a problem with one of the pods.</p>
<p>Running <code>kubectl describe</code> on that pod will give us more information.</p>
<div class="highlight"><pre class="highlight plaintext"><code>$ kubectl -n dstest describe pod helloworld-rubyapp-8795b9c56-58fbc
Name:               helloworld-rubyapp-8795b9c56-58fbc
Namespace:          dstest

...

Events:
  Type     Reason     Age                From                                                  Message
  ----     ------     ----               ----                                                  -------
  Normal   Scheduled  91s                default-scheduler                                     Successfully assigned dstest/helloworld-rubyapp-8795b9c56-58fbc to ip-172-20-60-236.eu-west-2.compute.internal
  Normal   Pulling    87s                kubelet, ip-172-20-60-236.eu-west-2.compute.internal  pulling image "754256621582.dkr.ecr.eu-west-2.amazonaws.com/webops/dstest:latest"
  Normal   Started    84s                kubelet, ip-172-20-60-236.eu-west-2.compute.internal  Started container
  Normal   Pulled     84s                kubelet, ip-172-20-60-236.eu-west-2.compute.internal  Successfully pulled image "754256621582.dkr.ecr.eu-west-2.amazonaws.com/webops/dstest:latest"
  Normal   Created    84s                kubelet, ip-172-20-60-236.eu-west-2.compute.internal  Created container
  Normal   Pulling    21s (x7 over 90s)  kubelet, ip-172-20-60-236.eu-west-2.compute.internal  pulling image "nginx"
  Normal   Pulled     20s (x7 over 87s)  kubelet, ip-172-20-60-236.eu-west-2.compute.internal  Successfully pulled image "nginx"
  Warning  Failed     20s (x7 over 87s)  kubelet, ip-172-20-60-236.eu-west-2.compute.internal  Error: container has runAsNonRoot and image will run as root
</code></pre></div><p>We&rsquo;ve omitted a lot of the detail, for clarity. The useful information, in this case, is at the bottom, in the <code>Events</code> section. On the last line:</p>
<div class="highlight"><pre class="highlight plaintext"><code>Error: container has runAsNonRoot and image will run as root
</code></pre></div><p>You can also see events across the whole namespace like this:</p>
<div class="highlight"><pre class="highlight plaintext"><code>kubectl -n dstest get events
</code></pre></div><p>Be aware that the ordering of events in the output of this command is a bit random.</p>
<p>Events are only stored in the cluster for around 30 minutes, but all events are also stored in Elasticsearch, and available via <a href="https://kibana.cloud-platform.service.justice.gov.uk/_plugin/kibana/app/kibana#/home?_g=()">Kibana</a>. To find events in your namespace, click on &ldquo;Discover&rdquo; in the upper-left, and then enter a query like this:</p>
<div class="highlight"><pre class="highlight plaintext"><code>kubernetes.namespace_name:"logging" AND kubernetes.labels.app:"eventrouter" AND log:"dstest"
</code></pre></div><p>(replace <code>dstest</code> with the name of your namespace)</p>
<p>You can adjust the timeframe and other parameters via the Kibana web interface.</p>
<h4 id="logs">Logs</h4><p>You can view the log output from a pod like this:</p>
<div class="highlight"><pre class="highlight plaintext"><code>$ kubectl -n dstest log helloworld-rubyapp-8795b9c56-58fbc
Error from server (BadRequest): a container name must be specified for pod helloworld-rubyapp-8795b9c56-58fbc, choose one of: [nginx rubyapp]
</code></pre></div><p>As you can see, that pod has two containers, and you need to specify which container&rsquo;s logs you want to see. If your pod only has a single container, you won&rsquo;t be prompted for its name.</p>
<div class="highlight"><pre class="highlight plaintext"><code>$ kubectl -n dstest log helloworld-rubyapp-8795b9c56-58fbc -c rubyapp
[2019-11-26 14:12:16] INFO  WEBrick 1.4.2
[2019-11-26 14:12:16] INFO  ruby 2.5.5 (2019-03-15) [x86_64-linux-musl]
== Sinatra (v2.0.7) has taken the stage on 4567 for development with backup from WEBrick
[2019-11-26 14:12:16] INFO  WEBrick::HTTPServer#start: pid=1 port=4567
</code></pre></div><p>You can tail the logs by appending <code>--follow</code> to that command.</p>
<p>Logs are also available via Kibana, as described <a href="tasks.html#accessing-application-log-data">here</a>.</p>
<h4 id="launching-a-shell">Launching a shell</h4><p>If your container has a shell installed (e.g. <code>bash</code>, <code>zsh</code>, or <code>sh</code>), you can exec onto the running container like this</p>
<div class="highlight"><pre class="highlight plaintext"><code>$ kubectl -n dstest exec -it helloworld-rubyapp-8795b9c56-58fbc -c rubyapp sh
/app $
</code></pre></div><h4 id="launching-a-new-container">Launching a new container</h4><p>You might want to make network calls from within your namespace, to test different components of your service. If your deployed containers don&rsquo;t have the tools you need (e.g. <code>wget</code>, <code>curl</code>), you can launch a new pod into your namespace like this:</p>
<div class="highlight"><pre class="highlight plaintext"><code>kubectl -n dstest run --generator=run-pod/v1 shell --rm -i --tty --image ministryofjustice/cloud-platform-tools -- bash
</code></pre></div><p>You could subtitute another image such as <code>busybox</code> or <code>alpine</code> instead of <code>ministryofjustice/cloud-platform-tools</code> if you prefer.</p>
<p>Once we have a shell on our new container, we can access the services running in our namespace like this:</p>
<div class="highlight"><pre class="highlight plaintext"><code>bash-4.4# curl rubyapp-service:4567
&lt;h1&gt;Hello, World!&lt;/h1&gt;
</code></pre></div><p>You can get the names and ports of the services running in your namespace, from <strong>outside</strong> the new container, like this:</p>
<div class="highlight"><pre class="highlight plaintext"><code>$ kubectl -n dstest get service
NAME              TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)    AGE
rubyapp-service   ClusterIP   100.65.254.2   &lt;none&gt;        4567/TCP   28d
</code></pre></div><h4 id="specific-errors">Specific Errors</h4><p>The remainder of this document covers particular errors you might encounter, and give advice on how to deal with them.</p>

<ul>
<li><a href="#my-pod-shows-createcontainerconfigerror-after-deployment">My pod shows &lsquo;CreateContainerConfigError&rsquo; after deployment</a></li>
<li><a href="#my-pod-shows-crashloopbackoff-after-deployment">My pod shows &#39;CrashLoopBackOff&rsquo; after deployment</a></li>
<li><a href="#my-pod-shows-imagepullbackoff-after-deployment">My pod shows &#39;ImagePullBackOff&rsquo; after deployment</a></li>
<li><a href="#i-get-the-error-39-container-is-unhealthy-it-will-be-killed-and-re-created-39">I get the error &#39;container is unhealthy, it will be killed and re-createdâ€™</a></li>
<li><a href="#i-get-the-error-39-error-from-server-forbidden-39-when-trying-to-run-kubectl-commands">I get the error &#39;Error from server (Forbidden)&rsquo; when trying to run kubectl commands</a></li>
</ul>
<h4 id="my-pod-shows-39-createcontainerconfigerror-39-after-deployment">My pod shows &#39;CreateContainerConfigError&rsquo; after deployment</h4><h5 id="scenario">Scenario</h5><p>You have deployed an application to the Cloud Platform and its status shows <code>CreateContainerConfigError</code> (you can get the status by running <code>kubect get pods -n &lt;namespace&gt;</code>).</p>
<h5 id="cause">Cause</h5><p>There are a number of reasons why this error will appear but the most probable cause is a missing secret or environment variable.</p>
<h5 id="troubleshooting">Troubleshooting</h5><p>To investigate this issue you&rsquo;ll want to look at the events of your pod. Run <code>kubectl -n &lt;namespace&gt; describe &lt;pod_name&gt;</code>, in the section titled <code>Events</code> you&rsquo;ll have something similar to:</p>
<div class="highlight"><pre class="highlight plaintext"><code>Events:
  Type     Reason     Age                    From                                                   Message
  ----     ------     ----                   ----                                                   -------
  Normal   Scheduled  54m                    default-scheduler                                      Successfully assigned myapplication-namespace/myapplication to worker-node
  Warning  Failed     49m (x8 over 53m)      kubelet, worker-node  Error: Couldn't find key postgresUser in Secret myapplication-dev/myapplication
</code></pre></div>
<blockquote>
<p>Note: you can also find this out using <code>kubectl -n &lt;namespace&gt; get events</code></p>
</blockquote>
<h5 id="solution">Solution</h5><p>Ensure all secrets and environment variables have been defined.</p>
<h4 id="my-pod-shows-crashloopbackoff-after-deployment">My pod shows <code>CrashLoopBackOff</code> after deployment</h4><h5 id="my-pod-shows-crashloopbackoff-after-deployment-scenario">Scenario</h5><p>Following the deployment of your application, you receive a status of <code>CrashLoopBackOff</code> when querying the pods in your namespace with <code>kubectl get pods -n &lt;namespace&gt;</code>.</p>
<h5 id="my-pod-shows-crashloopbackoff-after-deployment-cause">Cause</h5><p>A <code>CrashloopBackOff</code> means that you have a pod starting, crashing, starting again, and then crashing again.</p>
<p>A PodSpec has a restartPolicy field with possible values Always, OnFailure, and Never which applies to all containers in a pod. The default value is Always and the restartPolicy only refers to restarts of the containers by the kubelet on the same node (so the restart count will reset if the pod is rescheduled in a different node). Failed containers that are restarted by the kubelet are restarted with an exponential back-off delay (10s, 20s, 40s â€¦) capped at five minutes, and is reset after ten minutes of successful execution. This is an example of a PodSpec with the restartPolicy field:</p>
<div class="highlight"><pre class="highlight plaintext"><code>apiVersion: v1
kind: Pod
metadata:
  name: dummy-pod
spec:
  containers:
    - name: dummy-pod
      image: ubuntu
  restartPolicy: Always
</code></pre></div><p>The main causes of <code>CrashloopBackOff</code> are:</p>

<ul>
<li>The application inside the container keeps crashing.</li>
<li>Some parameters of the pod or container have been configured incorrectly.</li>
<li>An error has been made when deploying Kubernetes.</li>
</ul>
<h5 id="my-pod-shows-crashloopbackoff-after-deployment-troubleshooting">Troubleshooting</h5><p>As this issue is quite vague, you&rsquo;ll want to start by checking what your pod is printing to STDOUT using the command <code>kubectl -n &lt;namespace&gt; logs &lt;pod_name&gt;</code>. This should give you a clear understanding of whether the application has crashed. If your application is crashing, you need to identify the reason and try to fix it. Some possibilities are missing environment variables, insufficient resources, missing files or directories, or a lack of required permissions.</p>
<h5 id="my-pod-shows-crashloopbackoff-after-deployment-solution">Solution</h5><p>Fix application or misconfiguration errors.</p>
<h4 id="my-pod-shows-imagepullbackoff-after-deployment">My pod shows <code>ImagePullBackOff</code> after deployment</h4><h5 id="my-pod-shows-imagepullbackoff-after-deployment-scenario">Scenario</h5><p>You have deployed an application to the Cloud Platform and its status shows <code>ImagePullBackOff</code> (you can get the status by running <code>kubect get pods -n &lt;namespace&gt;</code>).</p>
<h5 id="my-pod-shows-imagepullbackoff-after-deployment-cause">Cause</h5><p>This error is caused by a misconfiguration in your deployment, there are three primary culprits besides network connectivity issues:</p>

<ul>
<li>The image tag is incorrect</li>
<li>The image doesn&rsquo;t exist (or is in a different registry)</li>
<li>Kubernetes doesn&rsquo;t have permissions to pull that image</li>
</ul>
<h5 id="my-pod-shows-imagepullbackoff-after-deployment-troubleshooting">Troubleshooting</h5><p>Again, utilising the <code>kubectl -n &lt;namespace&gt; describe &lt;pod_name&gt;</code> command you can see that the pod has failed to pull down the correct image:
<code>
  Normal   Pulling    10m (x4 over 12m)    kubelet, worker-node  pulling image &quot;redis:foobar&quot;
  Warning  Failed     10m (x4 over 12m)    kubelet, worker-node  Error: ErrImagePull
</code></p>
<h5 id="my-pod-shows-imagepullbackoff-after-deployment-solution">Solution</h5><p>This can be corrected by amending the <code>image</code> in your deployment.</p>
<h4 id="i-get-the-error-39-container-is-unhealthy-it-will-be-killed-and-re-created-39">I get the error &#39;container is unhealthy, it will be killed and re-created&rsquo;</h4><h5 id="situation">Situation</h5><p>Your pod appears to be jumping between an <code>error</code> and <code>ready</code> state. You describe the pod and get an error <code>container is unhealthy, it will be killed and re-created</code></p>
<h5 id="i-get-the-error-39-container-is-unhealthy-it-will-be-killed-and-re-created-39-cause">Cause</h5><p>Kubernetes provides two essential features called <a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-probes/">Liveness Probes and Readiness Probes</a>. Essentially, Liveness/Readiness Probes will periodically perform an action (e.g. make an HTTP request, open a tcp connection, or run a command in your container) to confirm that your application is working as intended.</p>
<p>If the Liveness Probe fails, Kubernetes will kill your container and create a new one. If the Readiness Probe fails, that Pod will not be available as a Service endpoint, meaning no traffic will be sent to that Pod until it becomes Ready.</p>
<h5 id="i-get-the-error-39-container-is-unhealthy-it-will-be-killed-and-re-created-39-troubleshooting">Troubleshooting</h5><p>Using the log output (<code>kubectl -n &lt;namespace&gt; &lt;pod_name&gt;</code>) you should see the cause of your Probe failure.</p>
<p>There are likely three possibilities:</p>

<ul>
<li> Your Probes are now incorrect - Did the health URL change?</li>
<li> Your Probes are too sensitive - Does your application take a while to start or respond?</li>
<li> Your application is no longer responding correctly to the Probe - Is your database misconfigured?</li>
</ul>
<h5 id="i-get-the-error-39-container-is-unhealthy-it-will-be-killed-and-re-created-39-solution">Solution</h5><p>Once a change has been made to either your application or Probe, a fresh deployment should succeed.</p>
<h4 id="i-get-the-error-39-error-from-server-forbidden-39-when-trying-to-run-kubectl-commands">I get the error &#39;Error from server (Forbidden)&rsquo; when trying to run kubectl commands</h4><h5 id="i-get-the-error-39-error-from-server-forbidden-39-when-trying-to-run-kubectl-commands-situation">Situation</h5><p>When attempting to use a command such as <code>kubectl get pods -n &lt;namespace&gt;</code> the following error occurs:</p>
<p><code>Error from server (Forbidden): pods is forbidden: User &quot;https://justice-cloud-platform.eu.auth0.com/#&lt;username&gt;&quot; cannot list resource &quot;pods&quot; in API group &quot;&quot; in the namespace &quot;&lt;namespace&gt;&quot;</code></p>
<h5 id="i-get-the-error-39-error-from-server-forbidden-39-when-trying-to-run-kubectl-commands-cause">Cause</h5><p>This is usually one of two things:</p>

<ul>
<li>Your token has expired and you need to re-authenticate.</li>
<li>You don&rsquo;t belong to the GitHub team assigned to the namespace you&rsquo;re attempting to communicate with.</li>
</ul>
<h5 id="i-get-the-error-39-error-from-server-forbidden-39-when-trying-to-run-kubectl-commands-troubleshooting">Troubleshooting</h5><p>First check if you&rsquo;re a member of the GitHub team assigned in your <a href="https://github.com/ministryofjustice/cloud-platform-environments/blob/master/namespaces/live-1.cloud-platform.service.justice.gov.uk/hmpps-book-secure-move-api-production/01-rbac.yaml#L8">rbac.yaml</a> file, which is located in the <a href="https://github.com/ministryofjustice/cloud-platform-environments/tree/master/namespaces">cloud-platform-environments</a> repository.</p>
<h5 id="i-get-the-error-39-error-from-server-forbidden-39-when-trying-to-run-kubectl-commands-solution">Solution</h5><p>Depending on the cause of your issue you&rsquo;ll need to do one of the following:</p>

<ul>
<li>Re-authenticate to the cluster using the <a href="https://user-guide.cloud-platform.service.justice.gov.uk/tasks.html#authentication">cloud-platform user-guide</a>.</li>
<li>Ask a team member to <a href="https://help.github.com/en/github/setting-up-and-managing-organizations-and-teams/adding-organization-members-to-a-team">add your GitHub user account</a> to the correct team (please note, the Cloud Platform team cannot do this for you).</li>
</ul>
