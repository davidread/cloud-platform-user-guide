---
title: Removing Deprecated Ingress APIs for K8s 1.22
last_reviewed_on: 2022-03-23
review_in: 3 months
---

# <%= current_page.data.title %>

Ingress APIs `extensions/v1beta1` and `networking.k8s.io/v1beta1` versions were deprecated and below guidance explains the changes required 
for updating the ingress manifest which is used to create Ingress resources in the cluster. 

Updating the Ingress APIs are **required** before Cloud Platform kubernetes cluster can be upgraded from **1.21** to **1.22**.

The replacement Ingress v1 APIs are already available within the current kubernetes version 1.21 and the existing persisted objects are accessible
via the new `v1` API. Below are the details of the changes required.

- The backend `serviceName` field is renamed to `service.name`
- Numeric backend `servicePort` fields are renamed to `service.port.number`
- String backend `servicePort` fields are renamed to `service.port.name`
- `pathType` is now required for each specified path. Options are `Prefix`, `Exact`, and `ImplementationSpecific`. 
   To match the undefined `v1beta1` behavior, use `ImplementationSpecific`.
- `spec.backend` is renamed to `spec.defaultBackend`

### How to identify that your ingress manifest is deprecated

When applying the ingress manifest into the cluster, you will see the below error which highlights that the 
request for the ingress you are making is deprecated and changes are required.

```
Warning: networking.k8s.io/v1beta1 Ingress is deprecated in v1.19+, 
unavailable in v1.22+; use networking.k8s.io/v1 Ingress
```

### Resources deployed using kubectl

If your ingress manifest looks similar to below:

<pre>
apiVersion: <b>networking.k8s.io/v1beta1</b>
kind: Ingress
metadata:
  name: helloworld
  annotations:
    external-dns.alpha.kubernetes.io/set-identifier: heloworld-mynamespace-green
    external-dns.alpha.kubernetes.io/aws-weight: "100"
spec:
  tls:
  - hosts:
    - helloworld-app.apps.live.cloud-platform.service.justice.gov.uk
  rules:
  - host: helloworld-app.apps.live.cloud-platform.service.justice.gov.uk
    http:
      paths:
      - <b>path: /
        backend:
          serviceName: helloworld
          servicePort: 4567</b>
</pre>

OR 

<pre>
apiVersion: <b>extensions/v1beta1</b>
kind: Ingress
metadata:
  name: helloworld
  annotations:
    external-dns.alpha.kubernetes.io/set-identifier: heloworld-mynamespace-green
    external-dns.alpha.kubernetes.io/aws-weight: "100"
spec:
  tls:
  - hosts:
    - helloworld-app.apps.live.cloud-platform.service.justice.gov.uk
  rules:
  - host: helloworld-app.apps.live.cloud-platform.service.justice.gov.uk
    http:
      paths:
      - <b>path: /
        backend:
          serviceName: helloworld
          servicePort: 4567</b>
</pre>
 
Migrate to use the <b>networking.k8s.io/v1</b> API version. Main changes include

 * Change the `apiVersion` to `networking.k8s.io/v1`
 * Add `pathType: ImplementationSpecific` after `path: /`
 * Rename `-backend.serviceName` to `-backend.service.name`
 * for String servicePort rename `-backend.servicePort` to `-backend.service.port.name`
 * For Numeric servicePort rename `-backend.servicePort` to `-backend.service.port.number`

The manifest after changes will look like:

<pre>
apiVersion: <b>networking.k8s.io/v1</b>
kind: Ingress
metadata:
  name: helloworld
  annotations:
    external-dns.alpha.kubernetes.io/set-identifier: heloworld-mynamespace-green
    external-dns.alpha.kubernetes.io/aws-weight: "100"
spec:
  tls:
  - hosts:
    - helloworld-app.apps.live.cloud-platform.service.justice.gov.uk
  rules:
  - host: helloworld-app.apps.live.cloud-platform.service.justice.gov.uk
    http:
      paths:
      - path: /
          <b>pathType: ImplementationSpecific
        backend:
          service:
            name: rubyapp-service
            port:
              number: 4567</b>
</pre>

To apply your changes:

```kubectl apply --filename ingress.yaml --namespace <namespace>```


### Resources deployed using helm chart

**NOTE** - Check the helm version

The Cloud Platform kubernetes version 1.21 is compatible with helm version 3.5.x so make sure you have the 
correct version installed before updating the manifest. If you are on older helm versions, you might get error as below:

```
Error: UPGRADE FAILED: rendered manifests contain a new resource that already exists. 
Unable to continue with update: existing resource conflict: namespace: XXX, name: YYYY,
existing_kind: networking.k8s.io/v1, Kind=Ingress, new_kind: networking.k8s.io/v1, Kind=Ingress
```

If your ingress manifest looks similar to below:

<pre>
{{- if .Values.ingress.enabled -}}
{{- $fullName := include "app.fullname" . -}}
{{- $ingressPath := .Values.ingress.path -}}
apiVersion: <b>networking.k8s.io/v1beta1</b>
kind: Ingress
metadata:
  name: {{ $fullName }}
  labels:
    {{- include "app.labels" . | nindent 4 }}
  annotations:
  {{- with .Values.ingress.annotations }}
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  tls:
  {{- range .Values.ingress.hosts }}
  - hosts:
    - {{ .host }}
    {{ if .cert_secret }}secretName: {{ .cert_secret }}{{ end }}
  {{- end }}
  rules:
  {{- range .Values.ingress.hosts }}
    - host: {{ .host }}
      http:
        paths:
          - <b>path: {{ $ingressPath }}
            backend:
              serviceName: {{ $fullName }}
              servicePort: http</b>
  {{- end }}
{{- end }}
</pre>

Migrate to use the networking.k8s.io/v1 API version. Main changes include

 * Change the `apiVersion` to `networking.k8s.io/v1`
 * Add `pathType: ImplementationSpecific` after `path: /`
 * Rename `-backend.serviceName` to `-backend.service.name`
 * for String servicePort rename `-backend.servicePort` to `-backend.service.port.name`
 * For Numeric servicePort rename `-backend.servicePort` to `-backend.service.port.number`
 * 

The manifest after changes will look like:

<pre>
  {{- if .Values.ingress.enabled -}}
{{- $fullName := include "app.fullname" . -}}
{{- $ingressPath := .Values.ingress.path -}}
apiVersion: <b>networking.k8s.io/v1beta1</b>
kind: Ingress
metadata:
  name: {{ $fullName }}
  labels:
    {{- include "app.labels" . | nindent 4 }}
  annotations:
  {{- with .Values.ingress.annotations }}
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  tls:
  {{- range .Values.ingress.hosts }}
  - hosts:
    - {{ .host }}
    {{ if .cert_secret }}secretName: {{ .cert_secret }}{{ end }}
  {{- end }}
  rules:
  {{- range .Values.ingress.hosts }}
    - host: {{ .host }}
      http:
        paths:
          - <b>path: {{ $ingressPath }}
            pathType: ImplementationSpecific
            backend:
              service:
                name: {{ $fullName }}
                port: 
                  name: http</b>
  {{- end }}
{{- end }}

</pre>

To apply your changes:

```
helm upgrade -f <values-file.yaml> <your-release> <your-chart> --namespace <your-namespace>
```

**NOTE: If you dont update your manifest to use the latest API versions after we upgraded to kubernetes 1.22, 
you will get failures when deploying your application.**

### Getting help

If you have any questions, please contact us on [#ask-cloud-platform] Slack channel.

[#ask-cloud-platform]: https://mojdt.slack.com/messages/C57UPMZLY