---
title: Long-running environments operations
last_reviewed_on: 2021-11-17
review_in: 3 months
---

# <%= current_page.data.title %>

Some operations on namespaces in the Cloud Platform can take a long time to
complete, e.g. upgrading an RDS instance from one version to another.

This means a scheduled [apply pipeline] run might try to operate on a namespace
while it is being modified.

We use [Terraform state locking] to ensure that this does not cause serious
problems, but at the least it would cause the [Apply Pipeline](/documentation/other-topics/apply-pipeline.html)
to timeout with an error if it can't acquire a lock on the target namespace's
terraform state.

For this reason, we have a mechanism to allow the Apply Pipeline to skip
individual namespaces during long-running operations.

To use this feature:

1. Prepare the terraform code change which implements your namespace change.
1. Before raising your PR, include a file called `APPLY_PIPELINE_SKIP_THIS_NAMESPACE` (this file merely has to exist - its contents are irrelevant).

> The file needs to be in the top-level folder for your namespace, e.g:
```
namespaces/live-1.cloud-platform.service.justice.gov.uk/mynamespace/APPLY_PIPELINE_SKIP_THIS_NAMESPACE
```

1. Raise your PR, and approve it when it is merged.
1. After your change has completed successfully, raise another PR to remove the `APPLY_PIPELINE_SKIP_THIS_NAMESPACE` file.

### Skip "live-1" environments during migration

When you [migrate your namespace environment to “live”][migrate-live-step], a file called `MIGRATED_SKIP_APPLY_THIS_NAMESPACE` is added to your namespace repository in [live-1][live-1-namespace], this will allow the [Apply Pipelines][apply-pipeline] to skip individual namespaces in "live-1", to avoid resource conflicts during [migration][migration-live].


[apply pipeline]: https://concourse.cloud-platform.service.justice.gov.uk/teams/main/pipelines/environments-terraform/jobs/apply-live-1
[Terraform state locking]: https://www.terraform.io/docs/language/state/locking.html
[migrate-command]: /documentation/other-topics/migrate-to-live.html#step-3-migrate-your-namespace-environment-to-quot-live-quot
[migration-live]: /documentation/other-topics/migrate-to-live.html#migrate-to-the-quot-live-quot-cluster
[apply-pipeline]: https://concourse.cloud-platform.service.justice.gov.uk/teams/main/pipelines/environments-terraform
[live-1-namespace]: https://github.com/ministryofjustice/cloud-platform-environments/tree/main/namespaces/live-1.cloud-platform.service.justice.gov.uk
[migrate-live-step]: /documentation/other-topics/migrate-to-live.html#step-3-migrate-your-namespace-environment-to-quot-live-quot
