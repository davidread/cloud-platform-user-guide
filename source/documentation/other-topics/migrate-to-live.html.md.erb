---
title: Migrate to the "Live" cluster
last_reviewed_on: 2021-07-20
review_in: 3 months
---

# <%= current_page.data.title %>

## Introduction

This document intends to act as a guide to helo you migrate your namespace from "Live-1" to "Live".

### Terms used in this document

There are some confusing names and terms used in this document. Here are a few:
- "Live-1" = The name of the current Cloud Platform (Kubernetes) cluster your namespace is deployed to.
- "Live" = The name of a new Cloud Platform (EKS) cluster that you'll need to migrate to.

## Why should you migrate

The Cloud Platform is a Kubernetes cluster deployed using a tool named kOps. When the Cloud Platform was conceived in 2017, Kubernetes management tools such as EKS (Elastic Kubernetes Service from AWS) and GKE (Google Kubernetes Engine) were in their infancy. An architecture decision record (ADR) was created with the understanding and acceptance of the extra management overhead and slightly slower release times. Since then, EKS has matured to a state where the benefits of running a multi-tenant cluster without the overhead of maintaining the control plane has become extremely attractive. If you wish to read more, please see this ADR.

## What are you migrating

You will be migrating your Cloud Platform namespace, all permissions and resources in your namespace [directory](). This doesn't include AWS resources.

## Prerequisites for migration

There are just a few things you need to ensure before you migrate between clusters.

- Ensure your containers are "stateless". During the transition between clusters, your pods will be running simultaniously between "Live" and "Live-1". Any state that your containers (inside the pod) store on disk or persistent volume (such as EBS) will not be copied to the new cluster.

- Check that multiple copies of your app can communicate simultaniously with AWS resources. These AWS resources will be shared between clusters. For example, your RDS instance will accept connections from pods in "Live" and "Live-1".

If this is a concern or you'd like to check in advance, please feel free to contact the Cloud Platform team.

## How to migrate

The rest of this document contains the steps required to perform the migration. This is very much a work in progress, so please leave feedback if you've either struggled to understand a step or feel it could be clarified further.

## Step 1 - Agree a time to perform the migration

During the process of migration high velocity apps will be unable to deploy to "Live-1". You should speak to your team and agree a time and date to attempt to migrate your namespace. It's also recommended that you get familiar with migrating a non-production namespace before attempting prod.

## Step 2 - Amend your ingress resource

To ensure that you can send traffic to both clusters simultaniously you must add an annotation to your `ingress` resource to allow traffic weighting.

This looks as follows:

```yaml
apiVersion: networking.k8s.io/v1beta1
kind: Ingress
metadata:
  annotations:
    external-dns.alpha.kubernetes.io/set-identifier: $namespace-live-1-cluster
    external-dns.alpha.kubernetes.io/aws-weight: "50"
```

(Note - Please change the `$namespace` value in the above example to the namespace you are migrating.)

The idea behind the annotation is to control where the traffic is going. Using the above example 50% of the traffic will be sent to the ingress in the "Live-1" cluster. In a later step, we will create another resource in the "Live" cluster that will weight the traffic between the two clusters.

## Step 3 - Copy the namespace directory from "Live"-1 to "Live"

Copy the [namespace]() directory from the [live-1.cloud-platform.service.justice.gov.uk]() parent directory to its sibling directory [live-1.cloud-platform.service.justice.gov.uk](). This change will need to reviewed by the Cloud Platform team. Create a pull request and wait for approval. An example can be seen [here]().

## Step 4 - Authenticate to the "Live" cluster

Grab a new set of credentials from [login.apps.live.cloud-platform.service.justice.gov.uk]().

## Step 4 - Add a new ingress resource

Create a duplicate ingress resource? How do we advise the user here?

## Step 5 - Create a new step to your deployment pipeline

There are multi ways people are deploying their application, this guide will cover two of them:

### Deploy with GitHub Actions

Add instructions for deploying to live with gha.

### Deploy with CircleCI

Add instructions for deploying to live with circle.

## Step 6 - Trigger your pipeline

Trigger your application pipeline. This is normally done manually or by a push to branch.

## Step 7 - Test your application

Test your application is working on the new cluster by performing manual tests. How do we test this?

## Step 8 - Start sending real traffic

## Step 9 - Weight live traffic between "Live" and "Live-1"

## Step 10 - Cleanup old "Live-1" namespace

## Links for the new cluster

## How to roll back

## Troubleshooting

## Feedback welcome
